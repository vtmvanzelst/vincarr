<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="L.Control.Layers.Tree.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="L.Control.Layers.Tree.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <style>
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0
        }
        .leaflet-control-layers {
            position: absolute;
            top: 40px;
            right: 0px; /*30 Adjusts distance of the layer control to the right */
            width: 175px;
            overflow-y:auto;
        }
        /* Style for the legend */
        .info.legend {
            background: white;
            padding: 10px;
            padding-right:50px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            position: relative;
            display: inline-block;
            margin-right: 5px;

        }
        .rotated-label {
            position: absolute;
            right: -60px; /* Adjusts distance of the label to the right */
            top: 50%;
            transform: rotate(-90deg) translateY(-50%);
            white-space: nowrap;
            font-size:14px
        }

        .legend div {
            display: flex;
            align-items: center;
        }

        .legend-color-box {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }






    </style>
    <meta charset="utf-8" />
    <title></title>
</head>

<body>
    <div id="map"></div>
    <script>
        var map = L.map('map').setView([-18.00389, 35.22763], 5);
        // L.tileLayer('https://api.maptiler.com/maps/hybrid/{z}/{x}/{y}.jpg?key=wImrYJmRMHPb5f5UO0XW', {
        //     attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>'
        // }).addTo(map);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '&copy; <a href="https://www.esri.com/en-us/home">Esri</a>, Earthstar Geographics'
        }).addTo(map);
        L.Control.geocoder().addTo(map);

        L.control.scale({
            metric: true,
            imperial: true,
            maxWidth: 100,
            position: 'bottomright'
        }).addTo(map);


        // Global Mangrove Watch layer
        var gmw2020 = new L.tileLayer.wms("https://nl2120.openearth.nl/geoserver/landscape/wms", {
            layers: 'landscape:GMW2020_v3',
            format: 'image/png',
            version: '1.1.0',
            transparent: true
        });


        var tidalmarsh = new L.tileLayer.wms("https://nl2120.openearth.nl/geoserver/landscape/wms", {
            layers: 'landscape:tidalmarsh_worthington_lzw',
            format: 'image/png',
            version: '1.1.0',
            transparent: true
        });


        // VINCARR layers

        // V2.0
        var inun_noveg_rp0100_v2_0 = new L.tileLayer.wms("https://nl2120.openearth.nl/geoserver/vincarr/wms", {
            layers: '00_floodmap_noveg',
            format: 'image/png',
            version: '1.1.0',
            transparent: true
        });

        var inun_veg_rp0100_v2_0 = new L.tileLayer.wms("https://nl2120.openearth.nl/geoserver/vincarr/wms", {
            layers: '01_floodmap_veg',
            format: 'image/png',
            version: '1.1.0',
            transparent: true
        });

        var inun_dif_rp0100_v2_0 = new L.tileLayer.wms("https://nl2120.openearth.nl/geoserver/vincarr/wms", {
            layers: '03_floodmap_dif_veg_noveg',
            format: 'image/png',
            version: '1.1.0',
            transparent: true
        });


        var inun_dif_extent_rp0100_v2_0 = new L.tileLayer.wms("https://nl2120.openearth.nl/geoserver/vincarr/wms", {
            layers: '09_floodextent_dif_veg_noveg',
            format: 'image/png',
            version: '1.1.0',
            transparent: true
        });

        //AQUACULTURE
        var inun_aqua_rp0100_v2_0 = new L.tileLayer.wms("https://nl2120.openearth.nl/geoserver/vincarr/wms", {
		            layers: '02_floodmap_aqua',
		            format: 'image/png',
		            version: '1.1.0',
		            transparent: true
        });

        var inun_dif_rp0100_aqua_veg_v2_0 = new L.tileLayer.wms("https://nl2120.openearth.nl/geoserver/vincarr/wms", {
            layers: '05_floodmap_dif_aqua_veg',
            format: 'image/png',
            version: '1.1.0',
            transparent: true
        });

        var inun_dif_extent_rp0100_aqua_veg_v2_0 = new L.tileLayer.wms("https://nl2120.openearth.nl/geoserver/vincarr/wms", {
            layers: '11_floodextent_dif_aqua_veg',
            format: 'image/png',
            version: '1.1.0',
            transparent: true
        });

        var EAAP_noveg = new L.tileLayer.wms("https://nl2120.openearth.nl/geoserver/vincarr/wms", {
            layers: 'EAAP_noveg_prot',
            format: 'image/png',
            version: '1.1.0',
            transparent: true
        });



        var baseTree = {
            label: 'BaseLayers',
            noShow: true,
            children: [
                {
                    label: 'Sattelite',
                    children: [
                        {label: 'EO', layer: map},
                    ]
                },
            ]
        };


        var ctl = L.control.layers.tree(null,baseTree,
            {
                namedToggle: true,
                collapseAll: 'Collapse all',
                expandAll: 'Expand all',
                collapsed: false,
            });

        ctl.addTo(map).collapseTree().expandSelected();


        var overlays = {
            label: "<span style='font-size: 14px;'>Map Layers</span>",
            children: [
                {
                    label: "<span style='font-size: 14px;'><b>Coastal Wetland cover</b></span>",
                    children: [
                        {label: "<span style='font-size: 12px;'>Tidal marshes</span>", layer: tidalmarsh},
                        {label: "<span style='font-size: 12px;'>Mangroves</span>", layer: gmw2020},
                    ]
                },
                {
                    label: "<span style='font-size: 14px;'><b>Flood maps (RP100)</b></span>",
                    children: [
                        {label: "<span style='font-size: 12px;'>Flood depth (noveg)</span>", layer: inun_noveg_rp0100_v2_0},
                        {label: "<span style='font-size: 12px;'>Flood depth (veg)</span>", layer: inun_veg_rp0100_v2_0},
                        {label: "<span style='font-size: 12px;'>Flood depth difference</span>", layer: inun_dif_rp0100_v2_0},
                        {label: "<span style='font-size: 12px;'>Flood extent difference</span>", layer: inun_dif_extent_rp0100_v2_0},
                        {label: "<span style='font-size: 12px;'>Flood depth (aqua)</span>", layer: inun_aqua_rp0100_v2_0},
                        {label: "<span style='font-size: 12px;'>Flood depth difference (aqua_veg)</span>", layer: inun_dif_rp0100_aqua_veg_v2_0},
                        {label: "<span style='font-size: 12px;'>Flood extent difference (aqua_veg)</span>", layer: inun_dif_extent_rp0100_aqua_veg_v2_0}
                    ]
                },
		{
                    label: "<span style='font-size: 14px;'><b>Socio-economic</b></span>",
                    children: [
                        {label: "<span style='font-size: 12px;'>EAAP (noveg)</span>", layer: EAAP_noveg}
                    ]
		}
            ]
        };


        ctl.setOverlayTree(overlays).collapseTree(false).expandSelected(true);



        // Initial layer setup: Add layers to map initially (for testing or default visibility)
        // tidalmarsh.addTo(map);
        gmw2020.addTo(map); //
        inun_noveg_rp0100_v2_0.addTo(map);

        // Adding Watermark
        L.Control.Watermark = L.Control.extend({
            onAdd: function (map) {
                var img = L.DomUtil.create('img');
                img.src = 'vincarr_logo_white_noletters.png';
                img.style.width = '200px';
                return img;
            },
            onRemove: function (map) { }
        });
        L.control.watermark = function (opts) {
            return new L.Control.Watermark(opts);
        };
        L.control.watermark({ position: 'bottomleft' }).addTo(map);






        // Legend



        var mangrovesLegend = L.control({ position: 'bottomright' });
        mangrovesLegend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend');
            div.innerHTML = '<div><div class="legend-color-box" style="background-color: #00e000;"></div> Mangroves (Bunting et al., 2022)</div>';
            return div;
        };

        var tidalmarshLegend = L.control({ position: 'bottomright' });
        tidalmarshLegend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend');
            div.innerHTML = '<div><div class="legend-color-box" style="background-color: #e9e501;"></div> Tidal marshes (Worthington et al., 2024)</div>';
            return div;
        };



        var inunNovegLegend = L.control({ position: 'bottomright' });
        inunNovegLegend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend');
            div.innerHTML = '<img src="https://nl2120.openearth.nl/geoserver/vincarr/wms?REQUEST=GetLegendGraphic&VERSION=1.1.0&FORMAT=image/png&LAYER=00_floodmap_noveg" alt="Legend"> <div class="rotated-label">Flood depth (noveg) [m]</div>'
            return div;
        };

        var inunvegLegend = L.control({ position: 'bottomright' });
        inunvegLegend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend');
            div.innerHTML = '<img src="https://nl2120.openearth.nl/geoserver/vincarr/wms?REQUEST=GetLegendGraphic&VERSION=1.1.0&FORMAT=image/png&LAYER=01_floodmap_veg" alt="Legend"> <div class="rotated-label">Flood depth (veg) [m]</div>'
            return div;
        };

        var inundifLegend = L.control({ position: 'bottomright' });
        inundifLegend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend');
            div.innerHTML = '<img src="https://nl2120.openearth.nl/geoserver/vincarr/wms?REQUEST=GetLegendGraphic&VERSION=1.1.0&FORMAT=image/png&LAYER=03_floodmap_dif_veg_noveg" alt="Legend"> <div class="rotated-label">Flood depth difference [m]</div>'
            return div;
        };

        var inundifextentLegend = L.control({ position: 'bottomright' });
        inundifextentLegend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend');
            div.innerHTML = '<div><div class="legend-color-box" style="background-color: #ca00ff;"></div> Flood extent reduction [-]</div>';
            return div;
        };

        mangrovesLegend.addTo(map);
        tidalmarshLegend.addTo(map);
        inunNovegLegend.addTo(map);
        inunvegLegend.addTo(map);
        inundifLegend.addTo(map);
        inundifextentLegend.addTo(map);



        function updateLegendVisibility(layer, legendControl) {
            if (map.hasLayer(layer)) {
                legendControl.addTo(map);
            } else {
                map.removeControl(legendControl);
            }
        }

        map.on('overlayadd', function (eventLayer) {
            if (eventLayer.layer === gmw2020) {
                updateLegendVisibility(gmw2020, mangrovesLegend);
            }

            if (eventLayer.layer === tidalmarsh) {
                updateLegendVisibility(tidalmarsh, tidalmarshLegend);
            }

            if (eventLayer.layer === inun_noveg_rp0100_v2_0) {
                updateLegendVisibility(inun_noveg_rp0100_v2_0, inunNovegLegend);
            }
            if (eventLayer.layer === inun_veg_rp0100_v2_0) {
                updateLegendVisibility(inun_veg_rp0100_v2_0, inunvegLegend);
            }
            if (eventLayer.layer === inun_dif_rp0100_v2_0) {
                updateLegendVisibility(inun_dif_rp0100_v2_0, inundifLegend);
            }
            if (eventLayer.layer === inun_dif_extent_rp0100_v2_0) {
                updateLegendVisibility(inun_dif_extent_rp0100_v2_0, inundifextentLegend);
            }

        });

        map.on('overlayremove', function (eventLayer) {
            if (eventLayer.layer === gmw2020) {
                updateLegendVisibility(gmw2020, mangrovesLegend);
            }
            if (eventLayer.layer === tidalmarsh) {
                updateLegendVisibility(tidalmarsh, tidalmarshLegend);
            }
            if (eventLayer.layer === inun_noveg_rp0100_v2_0) {
                updateLegendVisibility(inun_noveg_rp0100_v2_0, inunNovegLegend);
            }
            if (eventLayer.layer === inun_veg_rp0100_v2_0) {
                updateLegendVisibility(inun_veg_rp0100_v2_0, inunvegLegend);
            }
            if (eventLayer.layer === inun_dif_rp0100_v2_0) {
                updateLegendVisibility(inun_dif_rp0100_v2_0, inundifLegend);
            }
            if (eventLayer.layer === inun_dif_extent_rp0100_v2_0) {
                updateLegendVisibility(inun_dif_extent_rp0100_v2_0, inundifextentLegend);
            }

        });

        updateLegendVisibility(gmw2020, mangrovesLegend);
        updateLegendVisibility(tidalmarsh, tidalmarshLegend);
        updateLegendVisibility(inun_noveg_rp0100_v2_0, inunNovegLegend);
        updateLegendVisibility(inun_veg_rp0100_v2_0, inunvegLegend);
        updateLegendVisibility(inun_dif_rp0100_v2_0, inundifLegend);
        updateLegendVisibility(inun_dif_extent_rp0100_v2_0, inundifextentLegend);


        // Function to get pixel value from the WMS layer when clicked
        map.on('click', function (e) {
            var lat = e.latlng.lat;
            var lon = e.latlng.lng;
            var activeLayer = null;

            // Loop through all layers added to the map and check for active WMS layers
            map.getLayers().forEach(function (layer) {
                if (layer instanceof L.TileLayer.WMS && layer._map) {
                    activeLayer = layer;  // Get the WMS layer that is currently added to the map
                }
            });

            // If we have an active WMS layer
            if (activeLayer) {
                // Construct the WMS GetFeatureInfo URL
                var wmsUrl = activeLayer._url + "?service=WMS&version=1.1.0&request=GetFeatureInfo" +
                    "&layers=" + activeLayer.options.layers +
                    "&query_layers=" + activeLayer.options.layers +
                    "&srs=EPSG:4326" + // Adjust to the CRS you are using
                    "&x=" + Math.floor(e.containerPoint.x) + 
                    "&y=" + Math.floor(e.containerPoint.y) + 
                    "&width=256&height=256" + 
                    "&bbox=" + map.getBounds().toBBoxString() + 
                    "&format=image/png";

                // Perform the request to get the pixel value
                fetch(wmsUrl)
                    .then(response => response.text())
                    .then(data => {
                        // Handle the WMS response (it may be XML, image, or other)
                        // For this example, we'll just display the response as text in a popup
                        L.popup()
                            .setLatLng(e.latlng)
                            .setContent("Pixel Value from " + activeLayer.options.layers + ": " + data)
                            .openOn(map);
                    })
                    .catch(error => {
                        console.error("Error fetching WMS data:", error);
                    });
            } else {
                alert("No active layer found at clicked location.");
            }
        });


    </script>
</body>

</html>
